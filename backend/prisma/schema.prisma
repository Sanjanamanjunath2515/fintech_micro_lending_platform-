generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums removed for SQLite compatibility, handled as Strings in application logic
// valid Roles: APPLICANT, LOAN_OFFICER, RISK_ANALYST, ADMIN
// valid Statuses: APPLIED, UNDER_REVIEW, APPROVED, ACTIVE, REJECTED, CLOSED, DEFAULTED

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("APPLICANT")
  status    String   @default("ACTIVE") // ACTIVE, BLOCKED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile   Profile?
  loans     Loan[]
  auditLogs AuditLog[]
}

model Profile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  employmentType  String
  annualIncome    Float
  monthlyExpenses Float
  creditScore     Int      @default(300)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Loan {
  id             String     @id @default(uuid())
  userId         String
  user           User       @relation(fields: [userId], references: [id])
  amount         Float
  tenureMonths   Int
  status         String     @default("APPLIED")
  interestRate   Float      @default(10.0) 
  monthlyEmi     Float      @default(0.0)
  missedEmis     Int        @default(0)
  remainingAmount Float     @default(0.0)
  
  startDate      DateTime?
  endDate        DateTime?

  repayments     Repayment[]
  auditLogs      AuditLog[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model Repayment {
  id        String   @id @default(uuid())
  loanId    String
  loan      Loan     @relation(fields: [loanId], references: [id])
  amount    Float
  status    String   // "LATE", "ON_TIME", "PARTIAL"
  paidAt    DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String   // The actor (Loan Officer)
  user      User     @relation(fields: [userId], references: [id])
  action    String   // e.g., "LOAN_STATUS_CHANGE"
  loanId    String?
  loan      Loan?    @relation(fields: [loanId], references: [id])
  oldStatus String?
  newStatus String?
  details   String?
  timestamp DateTime @default(now())
}

model RiskRule {
  id        String   @id @default(uuid())
  name      String
  condition String
  value     Float
  createdAt DateTime @default(now())
}
